name: Upload Coverage Report

on:
  workflow_run:
    workflows:
      - Test
    types:
      - completed

jobs:
  upload:
    name: Upload
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.conclusion == 'success'
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: codecov.json
          run-id: ${{ github.event.workflow_run.id }}
      - uses: actions/checkout@v4
        name: Checkout codecov.yml
        with:
          sparse-checkout: |
            codecov.yml
          sparse-checkout-cone-mode: false
      - uses: actions/github-script@v7
        if: github.event.workflow_run.event == 'pull_request'
        name: Find associated pull request
        id: pr
        with:
          script: |
            const response = await github.rest.search.issuesAndPullRequests({
              q: `repo:${context.repo.owner}/${context.repo.repo} is:pr sha:${context.payload.workflow_run.head_sha}`,
              per_page: 1,
            });
            const items = response.data.items;
            if (items.length < 1) {
              console.error('No PRs found');
              return;
            }
            const pullRequestNumber = items[0].number;
            console.info("Pull request number is", pullRequestNumber);
            return pullRequestNumber;
      - name:
        env:
          PR_NUMBER: ${{ steps.pr.outputs.result }}
          EVENT_DATA: ${{ toJson(github.event) }}
        run: 'printf "pr: %s\nevent:\n%s\n" "$PR_NUMBER" "$EVENT_DATA"'
#      - uses: codecov/codecov-action@v4
#        if: hashFiles('codecov.json')
#        with:
#          token: ${{ secrets.CODECOV_TOKEN }}
#          commit_parent: ${{  }}
#          job_code: ${{ github.event.workflow.name }}
#          override_branch: ${{ }}
#          override_build: ${{ github.event.workflow_run.id }}
#          override_commit: ${{ github.event.workflow_run.head_sha }}
#          override_pr: ${{ steps.pr.outputs.result }}
# head_sha
